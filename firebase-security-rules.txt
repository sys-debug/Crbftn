// Firebase Security Rules for CRBFTN E-commerce Website
// Copy these rules to your Firebase Console > Firestore Database > Rules

rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // Users collection - users can only access their own data
    match /users/{userId} {
      allow read, write: if request.auth != null && request.auth.uid == userId;
      allow create: if request.auth != null 
        && request.auth.uid == userId
        && validateUserData(resource.data);
    }
    
    // Products collection - public read, admin write only
    match /products/{productId} {
      allow read: if true; // Public read access for all products
      allow write: if request.auth != null && isAdmin();
      
      // Product reviews subcollection
      match /reviews/{reviewId} {
        allow read: if true; // Public read for reviews
        allow create: if request.auth != null && validateReview(resource.data);
        allow update, delete: if request.auth != null 
          && (request.auth.uid == resource.data.userId || isAdmin());
      }
    }
    
    // Orders collection - users can only access their own orders
    match /orders/{orderId} {
      allow read, write: if request.auth != null 
        && request.auth.uid == resource.data.userId;
      allow create: if request.auth != null 
        && request.auth.uid == request.resource.data.userId
        && validateOrder(request.resource.data);
    }
    
    // Shopping cart collection - users can only access their own cart
    match /carts/{userId} {
      allow read, write: if request.auth != null && request.auth.uid == userId;
      
      // Cart items subcollection
      match /items/{itemId} {
        allow read, write: if request.auth != null && request.auth.uid == userId;
      }
    }
    
    // Wishlist collection - users can only access their own wishlist
    match /wishlists/{userId} {
      allow read, write: if request.auth != null && request.auth.uid == userId;
    }
    
    // Categories collection - public read, admin write
    match /categories/{categoryId} {
      allow read: if true; // Public read access
      allow write: if request.auth != null && isAdmin();
    }
    
    // Newsletter subscriptions - create only, admin read
    match /newsletter/{email} {
      allow create: if validateEmail(request.resource.data.email);
      allow read: if request.auth != null && isAdmin();
    }
    
    // Contact form submissions - create only, admin read
    match /contacts/{contactId} {
      allow create: if validateContactForm(request.resource.data);
      allow read: if request.auth != null && isAdmin();
    }
    
    // Site settings - admin only
    match /settings/{settingId} {
      allow read: if true; // Public read for site settings
      allow write: if request.auth != null && isAdmin();
    }
    
    // Admin collection - admin users only
    match /admins/{adminId} {
      allow read, write: if request.auth != null && isAdmin();
    }
    
    // HELPER FUNCTIONS
    
    // Check if user is admin
    function isAdmin() {
      return request.auth != null 
        && exists(/databases/$(database)/documents/admins/$(request.auth.uid));
    }
    
    // Validate user data
    function validateUserData(data) {
      return data.keys().hasAll(['email', 'displayName', 'createdAt'])
        && data.email is string
        && data.displayName is string
        && data.createdAt is timestamp;
    }
    
    // Validate product review
    function validateReview(data) {
      return data.keys().hasAll(['userId', 'productId', 'rating', 'comment', 'createdAt'])
        && data.userId is string
        && data.productId is string
        && data.rating is number
        && data.rating >= 1 && data.rating <= 5
        && data.comment is string
        && data.comment.size() <= 1000
        && data.createdAt is timestamp;
    }
    
    // Validate order data
    function validateOrder(data) {
      return data.keys().hasAll(['userId', 'items', 'total', 'status', 'createdAt'])
        && data.userId is string
        && data.items is list
        && data.items.size() > 0
        && data.total is number
        && data.total > 0
        && data.status in ['pending', 'processing', 'shipped', 'delivered', 'cancelled']
        && data.createdAt is timestamp;
    }
    
    // Validate email format
    function validateEmail(email) {
      return email is string 
        && email.matches('^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\\.[a-zA-Z]{2,}$');
    }
    
    // Validate contact form
    function validateContactForm(data) {
      return data.keys().hasAll(['name', 'email', 'message', 'createdAt'])
        && data.name is string
        && data.name.size() <= 100
        && validateEmail(data.email)
        && data.message is string
        && data.message.size() <= 2000
        && data.createdAt is timestamp;
    }
  }
}

// Storage Rules for Firebase Storage (for product images, user avatars)
// Copy these rules to Firebase Console > Storage > Rules

rules_version = '2';
service firebase.storage {
  match /b/{bucket}/o {
    
    // Product images - public read, admin write
    match /products/{productId}/{allPaths=**} {
      allow read: if true; // Public read access for product images
      allow write: if request.auth != null && isAdmin();
    }
    
    // User avatars - authenticated users can upload their own
    match /users/{userId}/avatar {
      allow read: if true; // Public read for avatars
      allow write: if request.auth != null 
        && request.auth.uid == userId
        && request.resource.size < 5 * 1024 * 1024 // 5MB limit
        && request.resource.contentType.matches('image/.*');
    }
    
    // Category images - admin only
    match /categories/{categoryId}/{allPaths=**} {
      allow read: if true; // Public read access
      allow write: if request.auth != null && isAdmin();
    }
    
    // Temporary uploads - authenticated users only, auto-delete after 1 day
    match /temp/{userId}/{fileName} {
      allow read, write: if request.auth != null 
        && request.auth.uid == userId
        && request.resource.size < 10 * 1024 * 1024; // 10MB limit
    }
    
    // Helper function for admin check (requires Firestore lookup)
    function isAdmin() {
      return request.auth != null && 
        firestore.get(/databases/(default)/documents/admins/$(request.auth.uid)).data != null;
    }
  }
}